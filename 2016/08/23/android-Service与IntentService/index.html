<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Service,IntentService,AIDL,远程服务,Service保活," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Service是什么？
Service的基本用法
Service#onStartCommand()的返回值
IntentService的用法
Bound Service
一些Service保活的方法

[TOC]
Service是什么？在android中Service是只在后台执行操作且没有页面的组件。Service可以被Service、Activity、ContentProvider启动/绑定">
<meta property="og:type" content="article">
<meta property="og:title" content="android-Service与IntentService">
<meta property="og:url" content="http://yoursite.com/2016/08/23/android-Service与IntentService/index.html">
<meta property="og:site_name" content="相信不可能">
<meta property="og:description" content="Service是什么？
Service的基本用法
Service#onStartCommand()的返回值
IntentService的用法
Bound Service
一些Service保活的方法

[TOC]
Service是什么？在android中Service是只在后台执行操作且没有页面的组件。Service可以被Service、Activity、ContentProvider启动/绑定">
<meta property="og:image" content="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg">
<meta property="og:image" content="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg">
<meta property="og:image" content="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg">
<meta property="og:updated_time" content="2016-08-23T09:31:24.461Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android-Service与IntentService">
<meta name="twitter:description" content="Service是什么？
Service的基本用法
Service#onStartCommand()的返回值
IntentService的用法
Bound Service
一些Service保活的方法

[TOC]
Service是什么？在android中Service是只在后台执行操作且没有页面的组件。Service可以被Service、Activity、ContentProvider启动/绑定">
<meta name="twitter:image" content="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/08/23/android-Service与IntentService/"/>

  <title> android-Service与IntentService | 相信不可能 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">相信不可能</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Just do it.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                android-Service与IntentService
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-23T10:55:52+08:00" content="2016-08-23">
              2016-08-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/23/android-Service与IntentService/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/23/android-Service与IntentService/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-file-o"></i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <ol>
<li>Service是什么？</li>
<li>Service的基本用法</li>
<li>Service#onStartCommand()的返回值</li>
<li>IntentService的用法</li>
<li>Bound Service</li>
<li>一些Service保活的方法</li>
</ol>
<p>[TOC]</p>
<h1 id="Service是什么？"><a href="#Service是什么？" class="headerlink" title="Service是什么？"></a>Service是什么？</h1><p>在android中Service是只在后台执行操作且没有页面的组件。Service可以被Service、Activity、ContentProvider启动/绑定，但是不可以被Broadcast启动/绑定。换句话说，Activity、ContentProvider可以绑定到Service并与之交互，甚至进行IPC通讯。</p>
<blockquote>
<p>服务根据用途不同而分为两类：启动的服务和绑定的服务。</p>
</blockquote>
<h1 id="Service的基本用法。"><a href="#Service的基本用法。" class="headerlink" title="Service的基本用法。"></a>Service的基本用法。</h1><p>要实现自己的Service去完成一些后台操作，必须继承自Service，并重写它的onCreate(), onStartCommand(), onDestroy()方法。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyService"</span>;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onStartCommand</span><span class="params">(intent, flags, startId)</span></span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在androidManifest.xml中进行注册</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Service android:<span class="built_in">name</span>=<span class="string">"packageName.MyService"</span>/&gt;</div></pre></td></tr></table></figure>
<p>这样一个完整的Service就完成了，现在我们只需要启动它就可以了。启动Service的方法和启动Activity的方法类似：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>(this, MyService.<span class="keyword">class</span>);</div><div class="line">startService(<span class="keyword">intent</span>);</div></pre></td></tr></table></figure>
<p>既然有启动Service，那么肯定有停止Service，停止Service的方法为：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>(this, MyService.<span class="keyword">class</span>);</div><div class="line">stopService(<span class="keyword">intent</span>);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：无论启动多少次Service，只要Service还没有被stop，那么Service#onCreate方法始终只执行一次。换言之，如果Service已经被启动了，Service#onCreate就不再执行了，但onStartCommand每次都会执行。</p>
</blockquote>
<p>Service虽然被用来处理一些后台任务，但它运行在主线程（MainThread），因此如果直接在onStartCommand()中执行耗时操作，则会阻塞主线程，具体表现为：除非onStartCommand()的耗时操作执行完毕，否则界面上无法进行任何操作。所以如果要在Service中执行耗时操作（例如网络请求，IO流处理），则必须创建Thread来完成这些耗时操作。那么有的朋友可能会问，既然后台的耗时操作要使用Thread来执行，那么又为什么使用Service呢？直接使用Thread就可以了呀！其实使用Service的原因在于android系统将Service的优先级设置的很高，也就是说，当系统因为内存不足而要回收某些任务时，Thread会比Service先被销毁来释放内存，而且Thread的存活与否与启动它的宿主（例如Activity）的销毁与否无关，那么如果宿主被销毁了，我们就无法控制Thread的存活了，但是Service则不同，我们可以随时随地的控制Service的存活。</p>
<p>其实，android还提供了一个叫做IntentService的组件来实现耗时操作的Service，也就是说，如果你使用IntentService替代Service，那么就不需要new一个Thread来执行耗时操作了，IntentService本身就提供了这种机制。</p>
<p>那么，现在我们来考虑一下：首先在Activity中启动Service，如果之后该Activity被finish掉了，那么此时Service会被destroy吗？答案是NO。想想看，既然Service是用来执行后台操作的，那么它肯定要独立于启动它的组件，否则Service就无法一直在后台执行了。但是，后面我们要说的绑定Service，则不是这样，如果绑定Service的客户端被销毁了，则该Service也被销毁，具体我们后边再来详细说明。</p>
<h1 id="Service-onStartCommand-的返回值"><a href="#Service-onStartCommand-的返回值" class="headerlink" title="Service#onStartCommand()的返回值"></a>Service#onStartCommand()的返回值</h1><p>在上一节我们注意到在Service#onStartCommand中返回了一个int值，那么这个值有什么作用呢？</p>
<p>Service#onStartCommand()可以返回四个值：START_STICKY, START_NOT_STICKY, START_REDELIVER_INTENT, START_STICKY_COMPATIBILITY.</p>
<p><strong>START_STICKY</strong>：返回该值则表示如果Service所在的进程被系统kill之后，将该Service置于started（已启动）状态，但是不会将第一次启动Service时的intent值恢复。因为该Service处于started状态，所以会保证重启Service之后再次执行onStartCommand()方法,此时如果没有intent传递过来，则将以null object的形式去调用。</p>
<p><strong>START_NOT_STICKY</strong>：返回该值则表示如果Service所在的进程被系统kill之后，则系统不会主动重启该Service。</p>
<p><strong>START_REDELIVERY_INTENT</strong>：见名知意，返回该值则表示如果Service所在的进程被系统kill之后，将该Service置于started（已启动）状态并将之前的intent值恢复。</p>
<p><strong>START_STICKY_COMPATIBILITY</strong>：START_STICKY的兼容版本，而且不保证Service所在的进程被kill之后，Service会被重启。</p>
<h1 id="IntentService的基本用法及原理"><a href="#IntentService的基本用法及原理" class="headerlink" title="IntentService的基本用法及原理"></a>IntentService的基本用法及原理</h1><p>正如上面所说的，IntentService是一种特殊的service，可以直接在里面执行耗时操作。</p>
<h2 id="IntentService的基本用法"><a href="#IntentService的基本用法" class="headerlink" title="IntentService的基本用法"></a>IntentService的基本用法</h2><p>首先我们肯定要继承IntentService，然后实现onHandleIntent(Intent intent)方法。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyIntentService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</div><div class="line"></div><div class="line">    public <span class="type">MyIntentService</span>() &#123;</div><div class="line">        <span class="keyword">super</span>(<span class="string">"MyIntentService"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> void onHandleIntent(<span class="type">Intent</span> intent) &#123;</div><div class="line">        <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">//do something consuming time.</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="type">Thread</span>.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (<span class="type">InterruptedException</span> e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;   </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在AndroidManifest中注册：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;service</div><div class="line">        android:<span class="built_in">name</span>=<span class="string">".service.MyIntentService"</span></div><div class="line">        android:exported=<span class="string">"false"</span>/&gt;</div></pre></td></tr></table></figure>
<p>之后我们像启动/停止Service一样去启动/停止IntentService即可。之后我们就可以在IntentService#onHandleIntent中执行耗时操作。</p>
<p>我们看到在注册service时，有时会使用android:exported这个属性，这个属性用来说明该Service是否可以被外部应用使用。默认为false。</p>
<h2 id="IntentService原理解析"><a href="#IntentService原理解析" class="headerlink" title="IntentService原理解析"></a>IntentService原理解析</h2><p>在android中，通常使用Handler来实现线程切换及协作，使用HandlerThread来创建一个带有Looper的线程。那么我们来看一下IntentService的源码，看看它是不是使用了Handler和HandlerThread来实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Looper mServiceLooper;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServiceHandler mServiceHandler;</div><div class="line">    <span class="keyword">private</span> String mName;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRedelivery;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(looper);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            onHandleIntent((Intent)msg.obj);</div><div class="line">            stopSelf(msg.arg1);<span class="comment">//停止自己</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates an IntentService.  Invoked by your subclass's constructor.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> name Used to name the worker thread, important only for debugging.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntentService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        mName = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets intent redelivery preferences.  Usually called from the constructor</div><div class="line">     * with your preferred semantics.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;If enabled is true,</div><div class="line">     * &#123;<span class="doctag">@link</span> #onStartCommand(Intent, int, int)&#125; will return</div><div class="line">     * &#123;<span class="doctag">@link</span> Service#START_REDELIVER_INTENT&#125;, so if this process dies before</div><div class="line">     * &#123;<span class="doctag">@link</span> #onHandleIntent(Intent)&#125; returns, the process will be restarted</div><div class="line">     * and the intent redelivered.  If multiple Intents have been sent, only</div><div class="line">     * the most recent one is guaranteed to be redelivered.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;If enabled is false (the default),</div><div class="line">     * &#123;<span class="doctag">@link</span> #onStartCommand(Intent, int, int)&#125; will return</div><div class="line">     * &#123;<span class="doctag">@link</span> Service#START_NOT_STICKY&#125;, and if the process dies, the Intent</div><div class="line">     * dies along with it.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntentRedelivery</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">        mRedelivery = enabled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> It would be nice to have an option to hold a partial wakelock</span></div><div class="line">        <span class="comment">// during processing, and to have a static startService(Context, Intent)</span></div><div class="line">        <span class="comment">// method that would launch the service &amp; hand off a wakelock.</span></div><div class="line"></div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"IntentService["</span> + mName + <span class="string">"]"</span>);</div><div class="line">        thread.start();</div><div class="line"></div><div class="line">        mServiceLooper = thread.getLooper();</div><div class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Message msg = mServiceHandler.obtainMessage();</div><div class="line">        msg.arg1 = startId;</div><div class="line">        msg.obj = intent;</div><div class="line">        mServiceHandler.sendMessage(msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * You should not override this method for your IntentService. Instead,</div><div class="line">     * override &#123;<span class="doctag">@link</span> #onHandleIntent&#125;, which the system calls when the IntentService</div><div class="line">     * receives a start request.</div><div class="line">     * <span class="doctag">@see</span> android.app.Service#onStartCommand</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        onStart(intent, startId);</div><div class="line">        <span class="keyword">return</span> mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        mServiceLooper.quit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Unless you provide binding for your service, you don't need to implement this</div><div class="line">     * method, because the default implementation returns null. </div><div class="line">     * <span class="doctag">@see</span> android.app.Service#onBind</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method is invoked on the worker thread with a request to process.</div><div class="line">     * Only one Intent is processed at a time, but the processing happens on a</div><div class="line">     * worker thread that runs independently from other application logic.</div><div class="line">     * So, if this code takes a long time, it will hold up other requests to</div><div class="line">     * the same IntentService, but it will not hold up anything else.</div><div class="line">     * When all requests have been handled, the IntentService stops itself,</div><div class="line">     * so you should not call &#123;<span class="doctag">@link</span> #stopSelf&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> intent The value passed to &#123;<span class="doctag">@link</span></div><div class="line">     *               android.content.Context#startService(Intent)&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@WorkerThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从源码我们可以看出，IntentService正是使用了Handler和HandlerThread来实现的，具体实现流程如下：
首先，我们要启动IntentService，那么则肯定会先执行onCreate方法，我们来看看其源码：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> It would be nice to have an option to hold a partial wakelock</span></div><div class="line">        <span class="comment">// during processing, and to have a static startService(Context, Intent)</span></div><div class="line">        <span class="comment">// method that would launch the service &amp; hand off a wakelock.</span></div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"IntentService["</span> + mName + <span class="string">"]"</span>);</div><div class="line">        thread.start();</div><div class="line">        mServiceLooper = thread.getLooper();</div><div class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在onCreate中，首先使用HandlerThread来创建一个带有Looper的线程，指定该线程的名字叫做mName，然后启动线程，接着得到该线程的Looper对象，得到Looper之后再去初始化Handler。至此，就完成了线程创建和线程切换的准备工作。</p>
<p>接着会去调用IntentService#onStartCommand()【先忽略返回值吧😄】,而onStartCommand又调用了onStart(),那么我们来看看onStart()方法的具体实现：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Message msg = mServiceHandler.obtainMessage();</div><div class="line">        msg.arg1 = startId;</div><div class="line">        msg.obj = intent;</div><div class="line">        mServiceHandler.sendMessage(msg);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从源码可以看出，在onStart中向Handler发送了一个Message，handler在接收到该Message之后会回调Handler#handlerMessage(Msg)方法，我们再来看看ServiceHandler的实现：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        public <span class="type">ServiceHandler</span>(<span class="type">Looper</span> looper) &#123;</div><div class="line">            <span class="keyword">super</span>(looper);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        public void handleMessage(<span class="type">Message</span> msg) &#123;</div><div class="line">            onHandleIntent((<span class="type">Intent</span>)msg.obj);</div><div class="line">            stopSelf(msg.arg1);<span class="comment">//停止自己</span></div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，在handleMessage方法中执行了耗时操作onHandleIntent，执行完耗时操作之后就停止自己。</p>
<p>至此，IntentService的实现原理已经非常清楚了：使用了HandlerThread来创建线程执行耗时操作，使用Handler来发送消息。</p>
<blockquote>
<p><strong>注意：</strong> IntentServie执行完耗时操作之后会自动停止</p>
</blockquote>
<p>在此，还有一个隐藏的知识点需要说明：我们已经知道，多次启动Service之后，Service#onCreate()只会执行一次，Service#onStartCommand()则会执行多次，那么在IntentService中，handler就会多次发送消息并执行耗时操作。由于Handler的消息机制使用了队列，那么在IntentService中，多次启动Service之后，这些耗时操作也会排队执行。</p>
<p>在此有的朋友就会问了：在IntentService中，执行完耗时操作之后会stopSelf，那么此时有多个任务排队等待处理，这岂不是自相矛盾吗？事实上不是如此，接下来我们一一说明：</p>
<p>我们可以看到在Service#onStartCommand(Intent intent, int flags, int startId)和stopSelf(int startId)中有一个参数startId，该参数标识每次启动Service的请求。startId初始值为1，如果在启动Service时，该Service已经被启动且未执行完毕，那么startId递增；如果启动Service时，该Service之前未被启动或已经自停止，则startId为1。startId标识了启动Service这个请求和对应的intent。所以每次stopSelf(startId)时，会关闭当前startId对应的Service，和队列中其他的Service无关。</p>
<h1 id="Bound-Service"><a href="#Bound-Service" class="headerlink" title="Bound Service"></a>Bound Service</h1><p>前面我们使用启动Service的方式使得Service来完成一些后台任务，但是启动Service的客户端和Service之间并没有做任何交互，那么二者如果要进行交互，则必须使用绑定Service的方式。</p>
<p>我们知道四大组件都可以通过设置android:process=”:remote”属性让其本身处于另一个进程，所以当我们绑定Service时，就有本地绑定和远程绑定之分。很明显本地绑定是指Service和客户端处于同一个进程，远程绑定则是Service和客户端处于不同的进程。其实使用startService(intent)启动Service时，也有本地启动和远程启动之分，但是通过startService(intent)启动的Service和客户端之间并没有做任何交互，而远程服务通常提供一些系统服务，需要客户端和Service之间进行交互，因此启动Service时无需使用远程模式。</p>
<h2 id="本地绑定"><a href="#本地绑定" class="headerlink" title="本地绑定"></a>本地绑定</h2><p>首先我们来看一下本地绑定的基本用法。在最开始的MyService中，有一个onBind()方法，我们让它返回null</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实onBind方法就是实现绑定服务的关键方法，要实现绑定服务必须要返回一个IBinder对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyService"</span>;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBinder();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="comment">//do something</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然我们返回了一个IBinder对象，但是我们如何在客户端来接受这个IBinder对象呢？系统为我们实现了ServiceConnection这个类来实现客户端与服务的连接。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection conn = <span class="keyword">new</span> ServiceConnection()&#123;</div><div class="line">    </div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onServiceConnected(ComponentName name, IBinder service)&#123;</div><div class="line">        MyBinder mb = (MyService.MyBinder)service;</div><div class="line">        mb.doSomething();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当服务连接异常终止后调用</div><div class="line">     */</div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">....</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 自定义方法，来实现绑定Service.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindService</span><span class="params">()</span></span>&#123;</div><div class="line">    Intent bindIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.<span class="keyword">class</span>);  </div><div class="line">    bindService(bindIntent, conn, BIND_AUTO_CREATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 自定义方法，来实现解绑Service.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unbindService</span><span class="params">()</span></span>&#123;</div><div class="line">    unbindService(conn);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这段代码我们可以看出，通过使用ServiceConnection来建立客户端与Service的连接。当连接成功之后会回调ServiceConnection#onServiceConnected(ComponentName name, IBinder service)方法，将IBinder对象传递过来，这样我们就可以像操作自己的方法一样去操作Service中Binder对象的方法。</p>
<blockquote>
<p><strong>注意</strong>：Service只能unbind一次，否则会报错： java.lang.IllegalArgumentException: Service not registered</p>
</blockquote>
<h2 id="远程绑定"><a href="#远程绑定" class="headerlink" title="远程绑定"></a>远程绑定</h2><p>现在我们来想想，如果我们直接将MyService改为远程服务，会有什么效果呢？不妨来做一个测试：直接设置MyService的android:process=”:remote”。设置完之后，当执行bindService时，报以下错误：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AndroidRuntime: FATAL EXCEPTION: main                                   Process: cn<span class="selector-class">.codemperor</span>, PID: <span class="number">10998</span></div><div class="line">java<span class="selector-class">.lang</span><span class="selector-class">.ClassCastException</span>: android<span class="selector-class">.os</span><span class="selector-class">.BinderProxy</span> cannot be cast to cn<span class="selector-class">.codemperor</span><span class="selector-class">.service</span><span class="selector-class">.MyService</span><span class="variable">$MyBinder</span></div></pre></td></tr></table></figure>
<p>咦？很奇怪！怎么会有android.os.BinderProxy这个东东呢？我们在任何地方都没有声明或使用它呀，它是怎么来的呢？是怎样和Service关联起来的呢？</p>
<p>要解决这个问题，必须先知道，远程绑定或者说访问远程服务都是IPC的，什么是IPC呢？IPC就是Inter Process Communication，即进程间通讯。在android中实现继承间通讯的方式是AIDL(Android Interface Define Language),即android接口定义语言。接下来我们先详细了解一下AIDL。</p>
<h3 id="AIDL基本概念及用途"><a href="#AIDL基本概念及用途" class="headerlink" title="AIDL基本概念及用途"></a>AIDL基本概念及用途</h3><p>首先我们应该明白AIDL的作用是：实现p1进程与p2进程之间的通信。也就是说AIDL提供了一种机制：只要定义了AIDL文件，并在AIDL文件中规定业务逻辑，然后系统就会自动根据业务逻辑实现p1与p2之间的通信。具体表现如下:
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AIDL文件--&gt;定义业务逻辑</div><div class="line">    |</div><div class="line"><span class="type">系统生成实现进程间通信的类文件--&gt;生成Stub</span>接口</div><div class="line">    |</div><div class="line"><span class="type">实现Stub</span>接口--&gt;实现业务逻辑</div></pre></td></tr></table></figure></p>
<p>这样一看，我们局很明确的知道AIDL实现进程间通讯的机制。其中Stub是Binder的子类。</p>
<p>那么接下来我们通过一个实例来具体说明一下远程绑定的实现</p>
<h3 id="远程服务实例–数据访问"><a href="#远程服务实例–数据访问" class="headerlink" title="远程服务实例–数据访问"></a>远程服务实例–数据访问</h3><p>首先，我们新建IDataAccess.aidl文件,并在启动数据访问方法accessData。</p>
<blockquote>
<p><strong>注意：</strong>在aidl文件中，不能出现private, public, protect修饰符。在AIDL文件中仅能支持基本类型、Map<string>、List<string>、自定义类型。因为自定义类型和其他类型的用法有所区别，我们先来看看非自定义类型的用法。</string></string></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.codempero.summary;</div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IDataAccess</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">accessData</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后系统会在/build/generated/source/aidl/debug/packageName/文件夹下自动生成IDataAccess.java文件，这个接口就实现了IPC。我们来看一下它的源代码
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * This file is auto-generated.  DO NOT MODIFY.</div><div class="line"> * Original file: D:\\LAB\\Development\\Summary\\app\\src\\main\\aidl\\cn\codemperor\summary\\IDataAccess.aidl</div><div class="line"> */</div><div class="line"><span class="keyword">package</span> cn.codemperor.summary;</div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDataAccess</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">/** Local-side IPC implementation stub class. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">cn</span>.<span class="title">codempero</span>.<span class="title">summary</span>.<span class="title">IDataAccess</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"cn.codempero.summary.IDataAccess"</span>;</div><div class="line"><span class="comment">/** Construct the stub at attach it to the interface. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Cast an IBinder object into an cn.codempero.summary.IDataAccess interface,</div><div class="line"> * generating a proxy if needed.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> cn.codempero.summary.<span class="function">IDataAccess <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> ((obj==<span class="keyword">null</span>)) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line"><span class="keyword">if</span> (((iin!=<span class="keyword">null</span>)&amp;&amp;(iin <span class="keyword">instanceof</span> cn.codempero.summary.IDataAccess))) &#123;</div><div class="line"><span class="keyword">return</span> ((cn.codempero.summary.IDataAccess)iin);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> cn.codempero.summary.IDataAccess.Stub.Proxy(obj);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></div><div class="line">&#123;</div><div class="line"><span class="keyword">switch</span> (code)</div><div class="line">&#123;.</div><div class="line"><span class="keyword">case</span> INTERFACE_TRANSACTION:</div><div class="line">&#123;</div><div class="line">reply.writeString(DESCRIPTOR);</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> TRANSACTION_accessData:</div><div class="line">&#123;</div><div class="line">data.enforceInterface(DESCRIPTOR);</div><div class="line"><span class="keyword">boolean</span> _result = <span class="keyword">this</span>.accessData();</div><div class="line">reply.writeNoException();</div><div class="line">reply.writeInt(((_result)?(<span class="number">1</span>):(<span class="number">0</span>)));</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> TRANSACTION_basicTypes:</div><div class="line">&#123;</div><div class="line">data.enforceInterface(DESCRIPTOR);</div><div class="line"><span class="keyword">int</span> _arg0;</div><div class="line">_arg0 = data.readInt();</div><div class="line"><span class="keyword">long</span> _arg1;</div><div class="line">_arg1 = data.readLong();</div><div class="line"><span class="keyword">boolean</span> _arg2;</div><div class="line">_arg2 = (<span class="number">0</span>!=data.readInt());</div><div class="line"><span class="keyword">float</span> _arg3;</div><div class="line">_arg3 = data.readFloat();</div><div class="line"><span class="keyword">double</span> _arg4;</div><div class="line">_arg4 = data.readDouble();</div><div class="line">java.lang.String _arg5;</div><div class="line">_arg5 = data.readString();</div><div class="line"><span class="keyword">this</span>.basicTypes(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5);</div><div class="line">reply.writeNoException();</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">cn</span>.<span class="title">codempero</span>.<span class="title">summary</span>.<span class="title">IDataAccess</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line">Proxy(android.os.IBinder remote)</div><div class="line">&#123;</div><div class="line">mRemote = remote;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> mRemote;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> DESCRIPTOR;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accessData</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span></div><div class="line">&#123;</div><div class="line">android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line"><span class="keyword">boolean</span> _result;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">_data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">mRemote.transact(Stub.TRANSACTION_accessData, _data, _reply, <span class="number">0</span>);</div><div class="line">_reply.readException();</div><div class="line">_result = (<span class="number">0</span>!=_reply.readInt());</div><div class="line">&#125;</div><div class="line"><span class="keyword">finally</span> &#123;</div><div class="line">_reply.recycle();</div><div class="line">_data.recycle();</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> _result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, java.lang.String aString)</span> <span class="keyword">throws</span> android.os.RemoteException</span></div><div class="line">&#123;</div><div class="line">android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">_data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">_data.writeInt(anInt);</div><div class="line">_data.writeLong(aLong);</div><div class="line">_data.writeInt(((aBoolean)?(<span class="number">1</span>):(<span class="number">0</span>)));</div><div class="line">_data.writeFloat(aFloat);</div><div class="line">_data.writeDouble(aDouble);</div><div class="line">_data.writeString(aString);</div><div class="line">mRemote.transact(Stub.TRANSACTION_basicTypes, _data, _reply, <span class="number">0</span>);</div><div class="line">_reply.readException();</div><div class="line">&#125;</div><div class="line"><span class="keyword">finally</span> &#123;</div><div class="line">_reply.recycle();</div><div class="line">_data.recycle();</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_accessData = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_basicTypes = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accessData</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, java.lang.String aString)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们可以看到，在IDataAccess接口里有一个叫做Stub的类，它实现了IDataAccess接口并继承自Binder，那么该类就是用来实现IPC通讯的本地Stub类。</p>
<p>那么现在我们还需要创建一个远程服务来实现具体的业务逻辑accessData。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyRemoteService"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRemoteService</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataAccessBinder</span> <span class="keyword">extends</span> <span class="title">IDataAccess</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accessData</span><span class="params">()</span></span>&#123;</div><div class="line">            Log.i(TAG, <span class="string">"You can access Me!"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, java.lang.String aString)</span></span>&#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们就需要将MyRemoteService注册在androidManifest.xml中</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;service </div><div class="line">    android:<span class="built_in">name</span>=<span class="string">"cn.codemperor.service.MyRemoteService"</span></div><div class="line">    android:exported=<span class="string">"true"</span></div><div class="line">    android:enable=<span class="string">"true"</span></div><div class="line">    android:process=<span class="string">":remote"</span></div><div class="line">/&gt;</div></pre></td></tr></table></figure>
<p>那么现在我们只需要像绑定本地服务一样绑定远程服务即可(真的可以吗？回想一下讲解远程绑定是的第一个异常 <img src="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg" alt="哈哈"> )。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection conn = <span class="keyword">new</span> ServiceConnection()&#123;</div><div class="line">    </div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onServiceConnected(ComponentName name, IBinder service)&#123;</div><div class="line">        MyRemoteService.MyBinder mb = (MyRemoteService.MyBinder)service;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mb.endCall();</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当服务连接异常终止后调用</div><div class="line">     */</div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">....</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 自定义方法，来实现绑定Service.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindService</span><span class="params">()</span></span>&#123;</div><div class="line">    Intent bindIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.<span class="keyword">class</span>);  </div><div class="line">    bindService(bindIntent, conn, BIND_AUTO_CREATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 自定义方法，来实现解绑Service.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unbindService</span><span class="params">()</span></span>&#123;</div><div class="line">    unbindService(conn);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>卧槽！卧槽！卧槽！怎么会奔溃了呢？什么玩意儿？客官别急，请先尝试一下下面的方法：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection conn = <span class="keyword">new</span> ServiceConnection()&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span></span>&#123;</div><div class="line">        IDataAccess iDataAccess = IDataAccess.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                iDataAccess.accessData();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当服务连接异常终止后调用</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span></span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哎呀！卧槽！对了！</p>
<p>我们来分析一下IDataAccess.Stub.asInterface(service)究竟做了什么</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> static <span class="literal">cn</span>.codempero.summary.IDataAccess asInterface(android.os.IBinder obj)&#123;</div><div class="line">    <span class="keyword">if</span> ((obj==<span class="built_in">null</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (((iin!=<span class="built_in">null</span>)&amp;&amp;(iin instanceof <span class="literal">cn</span>.codempero.summary.IDataAccess))) &#123;</div><div class="line">        <span class="keyword">return</span> ((<span class="literal">cn</span>.codempero.summary.IDataAccess)iin);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">new</span> <span class="literal">cn</span>.codempero.summary.IDataAccess.Stub.Proxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看了代码之后，仔细一想，对哟，通过AIDL访问的可是远程服务哎，是不处于同一个进程的呀！那么传递过来的IBinder对象不可能是本进程的IDataAccess呀，所以必须使用代理来访问。</p>
<p>说了这么多，远程Service使用起来如此复杂，好像还不知道为什么要用远程Service呢？</p>
<p>远程Service通常用来提供一些进程间共享的服务，通俗一点来说就是为手机上的App提供一个公共的服务，每个App都可以访问这个服务。</p>
<p>呵呵呵，那怎么在其他的App中访问远程服务呢？毕竟不同的App有不同的UID呀！</p>
<h2 id="在其他应用程序中访问远程服务"><a href="#在其他应用程序中访问远程服务" class="headerlink" title="在其他应用程序中访问远程服务"></a>在其他应用程序中访问远程服务</h2><p>最终我们的目的是：所有具有权限的应用程序都可以访问远程服务。那么只需要遵循以下流程即可访问到远程服务：</p>
<h5 id="1-新建名为ClientTest项目"><a href="#1-新建名为ClientTest项目" class="headerlink" title="1. 新建名为ClientTest项目"></a>1. 新建名为ClientTest项目</h5><h5 id="2-将IDataAccess-aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）"><a href="#2-将IDataAccess-aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）" class="headerlink" title="2. 将IDataAccess.aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）"></a>2. 将IDataAccess.aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">|<span class="string">——src</span></div><div class="line">|<span class="string">  └── main</span></div><div class="line">|<span class="string">  </span>|<span class="string">  </span>|<span class="string">  └── java</span></div><div class="line">|<span class="string">  </span>|<span class="string">  </span>|<span class="string">  └── cn.codemperor.clienttest</span></div><div class="line">|<span class="string">  </span>|<span class="string">  </span>|<span class="string">  └── cn.codemepror.summary</span></div><div class="line">|<span class="string">  </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">  └── IDataAccess.aidl</span></div></pre></td></tr></table></figure>
<h5 id="3-使用隐式Intent来访问远程服务"><a href="#3-使用隐式Intent来访问远程服务" class="headerlink" title="3. 使用隐式Intent来访问远程服务"></a>3. 使用隐式Intent来访问远程服务</h5><p>但是，呵呵呵，android5.0及以上可是禁止通过隐式intent的方式来访问Service的呀。所以呢？我们来了解一下shareUserId吧！ <img src="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg" alt="哈哈"> </p>
<p>在说shareUserId之前，我们先来说一下Android中的UID和PID吧！</p>
<p>我们已经知道，一个应用程序可以有多个进程，每个进程都有自己的PID，那么android中是如何来唯一标识应用程序的呢？linux是支持多用户多进程的，所以设计师采用UID来唯一标识一个用户，但是Android中只支持单用户，所以Google就将UID来唯一标识一个应用程序了，应用程序之间也可以通过UID来实现数据共享了。呵呵哒，说了这么多，具体应该怎么实现呢？so easy!只需要让两个应用程序拥有相同的shareUserId即可。</p>
<p> 应用程序A</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;manifest <span class="string">xmlns:</span>android=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">          <span class="keyword">package</span>=<span class="string">"com.codemperor.aApplication"</span></div><div class="line"><span class="symbol">　　　　　 android:</span>versionCode=<span class="string">"1"</span></div><div class="line"><span class="symbol">　　　　　 android:</span>versionName=<span class="string">"1.0"</span></div><div class="line"><span class="symbol">          android:</span>sharedUserId=<span class="string">"com.codemperor.share"</span>/&gt;</div></pre></td></tr></table></figure>
<p>应用程序B
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;manifest <span class="string">xmlns:</span>android=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">          <span class="keyword">package</span>=<span class="string">"com.codemperor.bApplication"</span></div><div class="line"><span class="symbol">　　　　　android:</span>versionCode=<span class="string">"1"</span></div><div class="line"><span class="symbol">　　　　　android:</span>versionName=<span class="string">"1.0"</span></div><div class="line"><span class="symbol">          android:</span>sharedUserId=<span class="string">"com.codemperor.share"</span>/&gt;</div></pre></td></tr></table></figure></p>
<p>哈哈哈，现在我们就可以使用显示intent的方式来绑定远程Service了（当然也可以通过同样的方式启动Activity，本地Service，BroadcastReceiver）。但是机智的朋友就会问了：如果我知道了你的shareUserId，那么我就可以随意访问你的应用程序咯？哈哈，Google怎会如此lowB，开发者都知道在打包App时，都会有自己的签名文件，而且该签名文件可是机密哟。不同签名的App可是不能实现数据共享的。</p>
<h2 id="在远程服务中使用自定义类型"><a href="#在远程服务中使用自定义类型" class="headerlink" title="在远程服务中使用自定义类型"></a>在远程服务中使用自定义类型</h2><p>前面我们提到，在远程服务中，仅支持几种类型的数据，虽然支持自定义类型，但用法有所不同。</p>
<p>首先我们定义一个Cat类型。据<a href="https://developer.android.com/guide/components/aidl.html#PassingObjects" target="_blank" rel="external">官方文档说明</a>,要再远程服务中使用自定义类型必须<a href="https://developer.android.com/reference/android/os/Parcelable.html" target="_blank" rel="external">Parcelable</a>。
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">package cn.codemperor.summary.bean;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Cat</span> <span class="title">implement</span> <span class="title">Parcelable</span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final Parcelable.Creator&lt;Cat&gt; CREATOR = <span class="keyword">new</span></div><div class="line">            Parcelable.Creator&lt;Cat&gt;() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> Cat <span class="title">createFromParcel</span>(<span class="params">Parcel <span class="keyword">in</span></span>) </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Cat(<span class="keyword">in</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="function"><span class="keyword">public</span> Cat[] <span class="title">newArray</span>(<span class="params"><span class="keyword">int</span> size</span>) </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Cat[size];</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">    String name;</div><div class="line">    String host;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Cat</span>(<span class="params">Parcel <span class="keyword">in</span></span>) </span>&#123;</div><div class="line">        name = <span class="keyword">in</span>.readString();</div><div class="line">        host = <span class="keyword">in</span>.readString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span>(<span class="params"></span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span>(<span class="params">Parcel dest, <span class="keyword">int</span> flags</span>) &#123;</div><div class="line">        dest.writeString(name);</div><div class="line">        dest.writeString(host);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在Cat所在的包下创建一个和自定义类型Cat同名的aidl文件，里面的内容固定为：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Cat.aidl</span></div><div class="line"><span class="keyword">package</span> cn.codemperor.summary.bean;</div><div class="line"></div><div class="line"><span class="comment">// Declare Rect so AIDL can find it and knows that it implements</span></div><div class="line"><span class="comment">// the parcelable protocol.</span></div><div class="line">parcelable Cat;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：Cat.aidl和Cat.java的包名必须一致，否则会查找不到。</p>
</blockquote>
<p>那么，现在我们就可以使用Cat类型了</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//导入Cat类，必须写</span></div><div class="line">import cn.codemperor.summary.bean.Cat;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> <span class="title">IDataAccess</span> &#123;</div><div class="line"></div><div class="line">    <span class="function">boolean <span class="title">accessData</span>(<span class="params"></span>)</span>;</div><div class="line"></div><div class="line">    <span class="function">Cat <span class="title">getCat</span>(<span class="params"></span>)</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 如果要在参数中使用自定义类型，必须添加in修饰符</div><div class="line">     **/</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCat</span>(<span class="params"><span class="keyword">in</span> Cat cat</span>)</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span>(<span class="params"><span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, boolean aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后在DataAccessBinder中重写getCat(), setCat(in Cat cat)即可。</p>
<p><strong>哈哈，前方高能，前方高能，前方高能</strong>
经过测试，使用getCat()返回的Cat对象不为空，但是cat.name, cat.host为null。</p>
<h1 id="其他进程间通讯的方式"><a href="#其他进程间通讯的方式" class="headerlink" title="其他进程间通讯的方式"></a>其他进程间通讯的方式</h1><h2 id="Messager"><a href="#Messager" class="headerlink" title="Messager"></a>Messager</h2><p>该部分较为简单，<a href="https://developer.android.com/guide/components/bound-services.html#Messenger" target="_blank" rel="external">点我</a>查看用法。</p>
<h1 id="一些Service保活的方法"><a href="#一些Service保活的方法" class="headerlink" title="一些Service保活的方法"></a>一些Service保活的方法</h1><h2 id="前台Service"><a href="#前台Service" class="headerlink" title="前台Service"></a>前台Service</h2><p>具体参见<a href="http://zhoujianghua.com/2015/07/28/black_technology_in_alipay/" target="_blank" rel="external">这里</a>,作者写的浅显易懂。</p>
<h2 id="onStartCommand的返回值"><a href="#onStartCommand的返回值" class="headerlink" title="onStartCommand的返回值"></a>onStartCommand的返回值</h2><p>不用再说了吧，哈哈哈哈哈哈<img src="http://oc1ju78pc.bkt.clouddn.com/%E5%93%88%E5%93%88%E5%93%88_%E5%A7%9A%E6%98%8E.jpg" alt="此处输入图片的描述"></p>
<h1 id="一些小知识点"><a href="#一些小知识点" class="headerlink" title="一些小知识点"></a>一些小知识点</h1><h2 id="android-process的值"><a href="#android-process的值" class="headerlink" title="android:process的值"></a>android:process的值</h2><p>(1). android:process=”com.xxx.xxxx.remote” 完整的命名方式，属于全局进程，其它应用通过ShareUID方式可以和它跑在同一个进程中。</p>
<p>(2). android:process=”:remote”，进程以“:”开头的进程属于当前应用的私有进程，其它应用的组件不可以和它跑在同一个进程中，“:”命名的进程会在当前的进程名之前附加上包名如：“com.xxx.xxxx:remote”。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>如果我的文章对您有用，请给我动力吧！O(∩_∩)O哈哈~</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechat_pay.png" alt="codempror WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/ali_pay.jpg" alt="codempror Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Service/" rel="tag">#Service</a>
          
            <a href="/tags/IntentService/" rel="tag">#IntentService</a>
          
            <a href="/tags/AIDL/" rel="tag">#AIDL</a>
          
            <a href="/tags/远程服务/" rel="tag">#远程服务</a>
          
            <a href="/tags/Service保活/" rel="tag">#Service保活</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/18/android-Activity与Fragment/" rel="next" title="android-Activity与Fragment">
                <i class="fa fa-chevron-left"></i> android-Activity与Fragment
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/24/android-BroadCast与StickBroadCast/" rel="prev" title="android-Broadcast">
                android-Broadcast <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/08/23/android-Service与IntentService/"
           data-title="android-Service与IntentService" data-url="http://yoursite.com/2016/08/23/android-Service与IntentService/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="codempror" />
          <p class="site-author-name" itemprop="name">codempror</p>
          <p class="site-description motion-element" itemprop="description">Just do it.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Service是什么？"><span class="nav-number">1.</span> <span class="nav-text">Service是什么？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Service的基本用法。"><span class="nav-number">2.</span> <span class="nav-text">Service的基本用法。</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Service-onStartCommand-的返回值"><span class="nav-number">3.</span> <span class="nav-text">Service#onStartCommand()的返回值</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IntentService的基本用法及原理"><span class="nav-number">4.</span> <span class="nav-text">IntentService的基本用法及原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IntentService的基本用法"><span class="nav-number">4.1.</span> <span class="nav-text">IntentService的基本用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IntentService原理解析"><span class="nav-number">4.2.</span> <span class="nav-text">IntentService原理解析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Bound-Service"><span class="nav-number">5.</span> <span class="nav-text">Bound Service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#本地绑定"><span class="nav-number">5.1.</span> <span class="nav-text">本地绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#远程绑定"><span class="nav-number">5.2.</span> <span class="nav-text">远程绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AIDL基本概念及用途"><span class="nav-number">5.2.1.</span> <span class="nav-text">AIDL基本概念及用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#远程服务实例–数据访问"><span class="nav-number">5.2.2.</span> <span class="nav-text">远程服务实例–数据访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在其他应用程序中访问远程服务"><span class="nav-number">5.3.</span> <span class="nav-text">在其他应用程序中访问远程服务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-新建名为ClientTest项目"><span class="nav-number">5.3.0.0.1.</span> <span class="nav-text">1. 新建名为ClientTest项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-将IDataAccess-aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）"><span class="nav-number">5.3.0.0.2.</span> <span class="nav-text">2. 将IDataAccess.aidl同包路径一起拷贝过来（该路径需要和ClientTest路径同级）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用隐式Intent来访问远程服务"><span class="nav-number">5.3.0.0.3.</span> <span class="nav-text">3. 使用隐式Intent来访问远程服务</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在远程服务中使用自定义类型"><span class="nav-number">5.4.</span> <span class="nav-text">在远程服务中使用自定义类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他进程间通讯的方式"><span class="nav-number">6.</span> <span class="nav-text">其他进程间通讯的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Messager"><span class="nav-number">6.1.</span> <span class="nav-text">Messager</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一些Service保活的方法"><span class="nav-number">7.</span> <span class="nav-text">一些Service保活的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前台Service"><span class="nav-number">7.1.</span> <span class="nav-text">前台Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#onStartCommand的返回值"><span class="nav-number">7.2.</span> <span class="nav-text">onStartCommand的返回值</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一些小知识点"><span class="nav-number">8.</span> <span class="nav-text">一些小知识点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#android-process的值"><span class="nav-number">8.1.</span> <span class="nav-text">android:process的值</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">codempror</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp</span></a>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhiho"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
